<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OMURGASIZ - Sesli Edition</title>
    <style>
        :root { --bg: #064e3b; --gold: #fbbf24; --dollar: #22c55e; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: sans-serif; touch-action: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        
        canvas { 
            display: block; 
            background: linear-gradient(to bottom, #143611, #064e3b); 
            z-index: 1; 
        }
        
        .ui { position: absolute; pointer-events: none; z-index: 20; color: white; }
        #status { top: 20px; left: 20px; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px #000; }
        #level-display { top: 20px; left: 50%; transform: translateX(-50%); font-size: 28px; font-weight: bold; color: var(--gold); }
        #kill-count { top: 60px; left: 20px; font-size: 18px; color: #ff4d4d; font-weight: bold; }
        
        #ui-layer { position: absolute; inset: 0; z-index: 30; pointer-events: none; }
        #joystick-wrapper { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); pointer-events: auto; display: flex; justify-content: center; align-items: center; }
        #joystick-stick { width: 50px; height: 50px; background: var(--gold); border-radius: 50%; }
        
        .action-buttons { position: absolute; bottom: 50px; right: 50px; display: flex; gap: 20px; pointer-events: auto; }
        .btn { width: 100px; height: 100px; background: rgba(251,191,36,0.6); border: 4px solid var(--gold); border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; cursor: pointer; text-align: center; font-size: 14px; color: white; text-shadow: 1px 1px 2px black; }
        .shoot-btn { background: rgba(34,197,94,0.6); border-color: #22c55e; }
        
        #overlay-screen { 
            position: absolute; 
            inset: 0; 
            background: rgba(0,0,0,0.95); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000;
            text-align: center; 
            color: white; 
        }
        #overlay-screen h1 { font-size: 80px; margin: 0; color: var(--gold); text-shadow: 0 0 20px rgba(251,191,36,0.8); }
        .story-note { background: rgba(251,191,36,0.1); border: 1px solid var(--gold); padding: 15px 30px; border-radius: 10px; font-style: italic; margin: 20px 0; max-width: 80%; font-size: 20px; color: #fbbf24; }
        .primary-btn { background: var(--gold); border: none; padding: 20px 60px; font-size: 28px; font-weight: bold; border-radius: 15px; cursor: pointer; pointer-events: auto; color: #000; transition: transform 0.2s; }
        .shake { animation: shake 0.5s both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px,0,0); } 30%, 70% { transform: translate3d(-8px,0,0); } 50% { transform: translate3d(8px,0,0); } }
    </style>
</head>
<body>

<div id="game-container">
    <div id="overlay-screen">
        <h1 id="overlay-title">OMURGASIZ</h1>
        <div class="story-note" id="overlay-note">"Bu omurgasız bir yüzükle çıkmıştı yollara.."</div>
        <p id="overlay-desc">Kul Hakkı Torbalarını Topla!</p>
        <button id="start-button" class="primary-btn">OYUNU BAŞLAT</button>
    </div>
    
    <div id="status" class="ui">Hazine: <span id="score">0</span></div>
    <div id="level-display" class="ui">Seviye: <span id="current-level">1</span></div>
    <div id="kill-count" class="ui">Leş: <span id="kills">0</span> / <span id="target-kills">4</span></div>
    
    <div id="ui-layer">
        <div id="joystick-wrapper"><div id="joystick-stick"></div></div>
        <div class="action-buttons">
            <div class="btn shoot-btn" id="shoot-btn">FIRLAT (Enter)</div>
            <div class="btn" id="jump-btn">ZIPLA (Space)</div>
        </div>
    </div>
    <canvas id="gameCanvas"></canvas>
</div>

<audio id="bg-music" loop><source src="pixel_spy_vs_spy.mp3" type="audio/mpeg"></audio>
<audio id="sfx-explosion"><source src="explosion.wav" type="audio/wav"></audio>
<audio id="sfx-pickup"><source src="pickupCoin.wav" type="audio/wav"></audio>

<script>
const apiKey = ""; 
const $ = id => document.getElementById(id);
const canvas = $('gameCanvas'), ctx = canvas.getContext('2d');

let width, height, score = 0, gameStarted = false, camX = 0, paused = false;
let items = [], platforms = [], enemies = [], projectiles = [], playerProjectiles = [], particles = [];
let killedEnemies = 0, currentLevel = 1, targetKills = 4, levelCompleted = false;
const keys = { a: false, d: false };

const GRAVITY = 0.95;

// Oyuncu Özellikleri
const player = { 
    x: 100, y: 0, w: 100, h: 140, 
    vx: 0, vy: 0, 
    speed: 7, jumpPower: -22, 
    grounded: false, dir: 1, 
    isDying: false, deathAngle: 0, 
    opacity: 1, legCycle: 0,
    mouthOpen: 0 
};

const imgPlayer = new Image(); imgPlayer.src = 'recep.jpg';
const imgEnemy = new Image(); imgEnemy.src = 'emine.jpg';

// TTS exponential backoff implementation
async function speak(text, voice = "Kore") {
    if (!apiKey) return;
    const makeCall = async () => {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                contents: [{ parts: [{ text: text }] }], 
                generationConfig: { 
                    responseModalities: ["AUDIO"], 
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } } } 
                }, 
                model: "gemini-2.5-flash-preview-tts" 
            })
        });
        if (!response.ok) throw new Error('API Error');
        return response.json();
    };

    let retryCount = 0;
    const delays = [1000, 2000, 4000, 8000, 16000];

    const attempt = async () => {
        try {
            const result = await makeCall();
            const pcmData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
            if (pcmData) {
                const audioBlob = pcmToWav(pcmData, 24000);
                const audio = new Audio(URL.createObjectURL(audioBlob));
                audio.play();
            }
        } catch (e) {
            if (retryCount < 5) {
                await new Promise(res => setTimeout(res, delays[retryCount]));
                retryCount++;
                return attempt();
            }
        }
    };
    attempt();
}

function pcmToWav(b64, rate) {
    const bin = atob(b64), bytes = new Uint8Array(bin.length);
    for (let i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
    const head = new ArrayBuffer(44), v = new DataView(head);
    v.setUint32(0, 0x52494646, false); v.setUint32(4, 36+bin.length, true); v.setUint32(8, 0x57415645, false);
    v.setUint32(12, 0x666d7420, false); v.setUint16(16, 16, true); v.setUint16(20, 1, true);
    v.setUint16(22, 1, true); v.setUint32(24, rate, true); v.setUint32(28, rate*2, true);
    v.setUint16(32, 2, true); v.setUint16(34, 16, true); v.setUint32(36, 0x64617461, false); v.setUint32(40, bin.length, true);
    return new Blob([head, bytes], { type: 'audio/wav' });
}

const playerVoices = ["Ham!", "Gelsin paracıklar!", "Yarasın!", "Çok lezzetli!", "Kul hakkı gibisi yok!"];

// --- ÇİZİM ---

function drawKulHakkiBag(ctx, x, y, size, angle = 0) {
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(angle);
    ctx.fillStyle = "#d4b483"; 
    ctx.beginPath();
    ctx.moveTo(-size/2, size/2);
    ctx.quadraticCurveTo(-size/1.5, -size/2, 0, -size/1.8);
    ctx.quadraticCurveTo(size/1.5, -size/2, size/2, size/2);
    ctx.closePath();
    ctx.fill();
    ctx.fillStyle = "#c2a373";
    ctx.fillRect(-size/6, -size/1.6, size/3, size/10);
    ctx.fillStyle = "#4a2c00";
    ctx.font = `bold ${size/6}px Arial`;
    ctx.textAlign = "center";
    ctx.fillText("KUL", 0, -5);
    ctx.fillText("HAKKI", 0, 10);
    ctx.strokeStyle = "rgba(0,0,0,0.3)";
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.restore();
}

function drawLuxuryHandbag(ctx, x, y, size, angle = 0) {
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(angle);
    
    // Çanta gövdesi
    ctx.fillStyle = "#3d0a0a"; 
    ctx.beginPath();
    ctx.roundRect(-size/2, -size/3, size, size*0.8, 5);
    ctx.fill();
    
    // Altın detay
    ctx.fillStyle = "#fbbf24";
    ctx.beginPath();
    ctx.arc(0, 0, size/6, 0, Math.PI * 2);
    ctx.fill();
    
    // Sap
    ctx.strokeStyle = "#2d0707";
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.arc(0, -size/3, size/3, Math.PI, 0);
    ctx.stroke();
    
    ctx.restore();
}

function drawDollarBill(ctx, x, y, size, angle) {
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(angle);
    ctx.fillStyle = "#22c55e"; 
    ctx.fillRect(-size, -size/2, size*2, size);
    ctx.strokeStyle = "#14532d";
    ctx.lineWidth = 1;
    ctx.strokeRect(-size, -size/2, size*2, size);
    ctx.fillStyle = "#f0fdf4";
    ctx.beginPath();
    ctx.ellipse(0, 0, size * 0.6, size * 0.4, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = "#166534";
    ctx.font = `bold ${size}px Arial`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("$", 0, 0);
    ctx.restore();
}

function createParticle(x, y, text = null, color = "white", duration = 1.0) {
    particles.push({
        x: x, y: y,
        vx: (Math.random() - 0.5) * 4,
        vy: text ? -2 : -Math.random() * 5,
        life: duration,
        maxLife: duration,
        size: Math.random() * 10 + 5,
        text: text,
        color: color
    });
}

function jump() { 
    if(player.grounded && !player.isDying && !paused && !levelCompleted) { 
        player.vy = player.jumpPower; 
        player.grounded = false; 
    } 
}

function shoot() {
    if(!gameStarted || player.isDying || paused || levelCompleted) return;
    playerProjectiles.push({ 
        x: player.x + (player.dir === 1 ? player.w : 0), 
        y: player.y + player.h / 2, 
        vx: player.dir * 14,
        vy: -5, angle: 0, life: 150, active: true 
    });
}

async function die() {
    if(player.isDying || levelCompleted) return;
    player.isDying = true;
    $('game-container').classList.add('shake');
    $('sfx-explosion').play();
    
    // Emine başarılı vuruş yaptığında GEBER yazısı çıkar
    createParticle(player.x + player.w/2, player.y + player.h/2, "GEBER!", "red", 2.0);
    
    speak("Eyvah!", "Kore");
    setTimeout(() => location.reload(), 2500);
}

function completeLevel() {
    if(levelCompleted) return;
    levelCompleted = true;
    paused = true;
    
    if (currentLevel === 1) {
        $('overlay-title').innerText = "BÖLÜM 1 TAMAM!";
        $('overlay-note').innerText = "Torbaları mideye indirdin! Şimdi sıra ikinci bölümde.";
        $('start-button').innerText = "2. BÖLÜME GEÇ";
        $('start-button').onclick = () => {
            currentLevel = 2; targetKills = 6;
            $('current-level').innerText = "2"; $('target-kills').innerText = "6";
            $('overlay-screen').style.display = 'none'; paused = false;
            createLevel();
        };
    } else {
        $('overlay-title').innerText = "ZAFER SİZİN!";
        $('overlay-note').innerText = "Karnımız doydu, ekonomi bitti!";
        $('start-button').innerText = "TEKRAR OYNA";
        $('start-button').onclick = () => location.reload();
    }
    $('overlay-screen').style.display = 'flex';
}

function createLevel() {
    items = []; enemies = []; projectiles = []; playerProjectiles = []; particles = [];
    killedEnemies = 0; levelCompleted = false;
    player.x = 100; player.y = 0; camX = 0;
    $('kills').innerText = "0";

    if (currentLevel === 1) {
        platforms = [
            {x: 0, y: height-60, w: 40000, h: 500},
            {x: 600, y: height-180, w: 200, h: 120},
            {x: 1200, y: height-250, w: 300, h: 50}, 
            {x: 1800, y: height-150, w: 150, h: 100},
            {x: 2300, y: height-350, w: 400, h: 50}
        ];
    } else {
        platforms = [
            {x: 0, y: height-60, w: 40000, h: 500},
            {x: 400, y: height-150, w: 150, h: 40},
            {x: 800, y: height-300, w: 150, h: 40},
            {x: 1200, y: height-450, w: 200, h: 40},
            {x: 1600, y: height-300, w: 300, h: 40}
        ];
    }

    for(let i=0; i<40; i++) {
        items.push({ x: 800 + i * 700, y: height - 150 - (Math.random() * 250), collected: false });
    }

    for(let i=0; i<20; i++) {
        enemies.push({ 
            x: 1500 + i * 1500, y: height - 270, w: 160, h: 210, 
            timer: 0, interval: 200, dead: false
        });
    }
}

function update() {
    if(!gameStarted || paused) return;

    if(!player.isDying) {
        let moveDir = (keys.a ? -1 : (keys.d ? 1 : 0));
        player.vx = moveDir ? moveDir * player.speed : player.vx * 0.85;
        if(moveDir) {
            player.dir = moveDir;
            player.legCycle += 0.2;
        }

        player.vy += GRAVITY; 
        player.x += player.vx;
        player.y += player.vy;

        if(player.mouthOpen > 0) player.mouthOpen -= 0.05;

        player.grounded = false;
        for(let p of platforms) {
            if (player.x + player.w * 0.2 < p.x + p.w && player.x + player.w * 0.8 > p.x &&
                player.y + player.h > p.y && player.y + player.h < p.y + p.h + player.vy + 10 && player.vy >= 0) {
                player.y = p.y - player.h; player.vy = 0; player.grounded = true;
            }
        }
    } else {
        player.y += 2; player.deathAngle += 0.05; player.opacity -= 0.01;
    }

    particles.forEach(p => { p.x += p.vx; p.y += p.vy; p.life -= (1/60); });
    particles = particles.filter(p => p.life > 0);
    camX = player.x - width/2;

    items.forEach(it => {
        if(!it.collected && Math.hypot(player.x + player.w/2 - it.x, player.y + player.h/2 - it.y) < 100) {
            it.collected = true; 
            score += 5000; 
            $('score').innerText = score;
            $('sfx-pickup').currentTime = 0; $('sfx-pickup').play();
            player.mouthOpen = 1.0; 
            speak(playerVoices[Math.floor(Math.random()*playerVoices.length)], "Kore");
            createParticle(it.x, it.y, "MİS!", "#22c55e", 0.8);
        }
    });

    enemies.forEach(en => {
        if(en.dead) return;
        if(Math.abs(en.x - player.x) < 1200 && ++en.timer > en.interval) {
            en.timer = 0;
            // Çantaların menzili (life) kahramanın mermisinin (150) iki katı: 300
            projectiles.push({ 
                x: en.x, 
                y: en.y + 60, 
                vx: (player.x < en.x ? -10 : 10), 
                vy: -12, // Başlangıç yukarı hızı (yer çekimi etkisi için)
                active: true, 
                life: 300, 
                angle: 0 
            });
        }
        if(!player.isDying && player.x + 40 < en.x + en.w - 40 && player.x + player.w - 40 > en.x && player.y + player.h > en.y && player.y < en.y + en.h) {
            if(player.vy > 0 && player.y + player.h < en.y + 60) {
                en.dead = true; 
                player.vy = -18; 
                killedEnemies++;
                // Kahraman Emine'yi öldürürse "aaah" yazısı çıkar
                createParticle(en.x + en.w/2, en.y, "aaah", "white", 1.0);
                speak("ANAM", "Aoede");
                $('score').innerText = score += 2000; $('kills').innerText = killedEnemies;
                if(killedEnemies >= targetKills) setTimeout(completeLevel, 500);
            } else die();
        }
    });

    playerProjectiles.forEach(p => {
        p.x += p.vx; p.vy += GRAVITY * 0.4; p.y += p.vy; p.angle += 0.2; p.life--;
        enemies.forEach(en => {
            if(!en.dead && p.active && p.x > en.x && p.x < en.x + en.w && p.y > en.y && p.y < en.y + en.h) {
                en.dead = true; 
                p.active = false; 
                killedEnemies++;
                // Kahraman vuruşla öldürürse "aaah" yazısı çıkar
                createParticle(en.x + en.w/2, en.y, "aaah", "white", 1.0);
                speak("ANAM", "Aoede");
                $('kills').innerText = killedEnemies;
                if(killedEnemies >= targetKills) setTimeout(completeLevel, 500);
            }
        });
    });
    playerProjectiles = playerProjectiles.filter(p => p.active && p.life > 0);

    projectiles.forEach(p => {
        p.x += p.vx; 
        p.vy += 0.25; // Çantaya eklenen yer çekimi (gravity)
        p.y += p.vy; 
        p.angle += 0.1;
        p.life--;
        if(!player.isDying && p.active && Math.hypot(p.x - (player.x + player.w/2), p.y - (player.h/2 + player.y)) < 80) {
            p.active = false;
            die();
        }
    });
    projectiles = projectiles.filter(p => p.active && p.life > 0);
}

function draw() {
    ctx.clearRect(0,0,width,height);
    ctx.save();
    ctx.translate(-camX, 0);

    platforms.forEach(p => {
        ctx.fillStyle = "#2d1b0d"; ctx.fillRect(p.x, p.y, p.w, p.h);
        ctx.fillStyle = "#1e4d16"; ctx.fillRect(p.x, p.y, p.w, 15);
    });

    items.forEach(it => { if(!it.collected) drawKulHakkiBag(ctx, it.x, it.y, 80); });
    enemies.forEach(en => { if(!en.dead) ctx.drawImage(imgEnemy, en.x, en.y, en.w, en.h); });

    ctx.save();
    ctx.translate(player.x + player.w/2, player.y + player.h/2);
    ctx.globalAlpha = player.opacity;
    if(player.isDying) ctx.rotate(player.deathAngle);
    if(player.dir === -1 && !player.isDying) ctx.scale(-1, 1);

    ctx.fillStyle = "#000";
    ctx.fillRect(-15 + Math.sin(player.legCycle)*30, player.h/2 - 15, 30, 15);
    ctx.fillRect(-15 + Math.sin(player.legCycle + Math.PI)*30, player.h/2 - 15, 30, 15);

    ctx.drawImage(imgPlayer, -player.w/2, -player.h/2, player.w, player.h);

    if(player.mouthOpen > 0.1) {
        ctx.fillStyle = "black";
        ctx.beginPath();
        ctx.ellipse(0, 30, 35 * player.mouthOpen, 45 * player.mouthOpen, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "white";
        ctx.fillRect(-10, 30 - 30 * player.mouthOpen, 20, 10 * player.mouthOpen);
    }
    ctx.restore();

    playerProjectiles.forEach(p => {
        drawDollarBill(ctx, p.x, p.y, 20, p.angle);
    });
    
    projectiles.forEach(p => {
        drawLuxuryHandbag(ctx, p.x, p.y, 55, p.angle);
    });

    particles.forEach(p => {
        ctx.globalAlpha = p.life / (p.maxLife || 1);
        if(p.text) {
            ctx.fillStyle = p.color;
            ctx.font = "bold 40px Arial";
            ctx.textAlign = "center";
            ctx.fillText(p.text, p.x, p.y);
        } else {
            ctx.fillStyle = "white";
            ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
        }
    });

    ctx.restore();
}

function loop() { update(); draw(); requestAnimationFrame(loop); }

window.onkeydown = e => { 
    let k = e.key.toLowerCase();
    if(k==='a') keys.a=true; if(k==='d') keys.d=true; 
    if(e.key===' ') jump(); if(e.key==='Enter') shoot(); 
};
window.onkeyup = e => { 
    let k = e.key.toLowerCase();
    if(k==='a') keys.a=false; if(k==='d') keys.d=false; 
};

$('start-button').onclick = () => {
    $('overlay-screen').style.display = 'none';
    gameStarted = true;
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
    createLevel();
    loop();
    const bgMusic = $('bg-music');
    bgMusic.volume = 0.1; bgMusic.play().catch(()=>{});
};

$('jump-btn').onclick = jump;
$('shoot-btn').onclick = shoot;
window.onresize = () => { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; };
</script>
</body>
</html>